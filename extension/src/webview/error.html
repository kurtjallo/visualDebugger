<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Error Explanation — Visual Debugger</title>
    <link rel="stylesheet" href="styles.css" />
    <script src="config.js"></script>
</head>

<body>
    <div id="error-panel">
        <!-- Header with category badge -->
        <div class="card-header">
            <h1>Error Explanation</h1>
        </div>

        <!-- Empty state — shown before any error is detected -->
        <div id="empty-state" class="card" style="text-align: center; padding: 32px 16px;">
            <p style="font-size: 1.1em; margin-bottom: 8px;">No errors detected yet.</p>
            <p class="text-muted text-sm">Run your program and Visual Debugger will automatically explain any errors that appear.</p>
        </div>

        <!-- Error content — hidden until an error is received -->
        <div id="error-content" style="display: none;">

        <!-- Error Location Card -->
        <div class="card slide-in" id="location-card">
            <div class="card-header" style="border-bottom: none; margin-bottom: 8px; padding-bottom: 0;">
                <span class="badge" id="category-badge"></span>
                <span class="text-muted text-sm" id="error-location"></span>
            </div>
            <p id="error-message" style="word-break: break-word; font-family: var(--vscode-editor-font-family, monospace); background-color: var(--vscode-textCodeBlock-background); padding: 8px; border-radius: 3px;">
            </p>
        </div>

        <!-- What Happened -->
        <div class="card slide-in" id="explanation-card">
            <div class="section">
                <div class="section-title">What Happened</div>
                <div class="section-content" id="explanation-text"></div>
            </div>
        </div>

        <!-- How to Fix -->
        <div class="card slide-in" id="fix-card">
            <div class="section">
                <div class="section-title">How to Fix</div>
                <div class="section-content" id="fix-text"></div>
            </div>
        </div>

        <!-- How to Prevent -->
        <div class="card slide-in" id="prevent-card">
            <div class="section">
                <div class="section-title">How to Prevent</div>
                <div class="section-content" id="prevent-text"></div>
            </div>
        </div>

        <!-- Best Practices -->
        <div class="card slide-in" id="practices-card">
            <div class="section">
                <div class="section-title">Best Practices</div>
                <div class="section-content" id="practices-text"></div>
            </div>
        </div>

        <!-- Quiz Section -->
        <div class="card slide-in" id="quiz-card">
            <div class="section">
                <div class="section-title">Test Yourself</div>
                <p class="mb-8" id="quiz-question"></p>
                <div class="quiz-options" id="quiz-options">
                    <!-- Options rendered by JS -->
                </div>
                <div class="quiz-feedback" id="quiz-feedback" style="display:none;"></div>
            </div>
        </div>

        </div><!-- close #error-content -->

        <!-- TTS Controls -->
        <div class="mt-12" id="tts-controls" style="display: none; align-items: center; gap: 10px; flex-wrap: wrap; margin-top: 20px;">
            <div class="voice-toggle-group">
                <button class="voice-toggle active" id="voice-female">Female</button>
                <button class="voice-toggle" id="voice-male">Male</button>
            </div>
            <button class="btn btn--secondary" id="tts-btn">Read Aloud</button>
        </div>
    </div>

    <script>
        // ── State ──
        let quizAnswered = false;
        let currentErrorData = null;

        // ── Helper: map quiz letter ("A"/"B"/"C"/"D") to 0-indexed number ──
        function quizCorrectIndex(val) {
            if (typeof val === 'number') return val;
            const map = { A: 0, B: 1, C: 2, D: 3 };
            return map[val] ?? 0;
        }

        // ── Main Update Function ──
        function updatePanel(data) {
            currentErrorData = data;
            quizAnswered = false;

            // 1. Header & Location
            const badge = document.getElementById('category-badge');
            badge.textContent = data.category;
            badge.className = 'badge'; // Reset classes
            badge.setAttribute('data-type', data.category.split(' ')[0]); // For CSS targeting (Syntax/Logic/Runtime)
            
            // Add specific logic for badge color fallback if CSS variable targeting fails
            const type = data.category.split(' ')[0];
            if(type === 'Syntax') { badge.style.color = 'var(--ff-syntax)'; badge.style.borderColor = 'var(--ff-syntax)'; }
            else if(type === 'Logic') { badge.style.color = 'var(--ff-logic)'; badge.style.borderColor = 'var(--ff-logic)'; }
            else if(type === 'Runtime') { badge.style.color = 'var(--ff-runtime)'; badge.style.borderColor = 'var(--ff-runtime)'; }
            
            document.getElementById('error-location').textContent = data.location || (data.raw && data.raw.file + ':' + data.raw.line) || '';
            const errorMsg = data.errorMessage || (data.raw && data.raw.message) || '';
            document.getElementById('error-message').textContent = errorMsg;

            // 2. Content Sections
            document.getElementById('explanation-text').innerHTML = data.explanation;

            const howToFix = data.howToFix;
            if (Array.isArray(howToFix)) {
                const fixList = howToFix.map(step => `<li>${step}</li>`).join('');
                document.getElementById('fix-text').innerHTML = `<ol style="padding-left: 18px; margin: 0;">${fixList}</ol>`;
            } else {
                document.getElementById('fix-text').innerHTML = howToFix || '';
            }

            document.getElementById('prevent-text').innerHTML = data.howToPrevent || '';
            document.getElementById('practices-text').innerHTML = data.bestPractices || '';

            // 3. Quiz
            const quizCard = document.getElementById('quiz-card');
            if (data.quiz) {
                const correctIdx = quizCorrectIndex(data.quiz.correct);
                quizCard.style.display = 'block';
                document.getElementById('quiz-question').innerHTML = data.quiz.question;
                const quizOptions = document.getElementById('quiz-options');
                quizOptions.innerHTML = '';
                document.getElementById('quiz-feedback').style.display = 'none';

                data.quiz.options.forEach((option, index) => {
                    const optionEl = document.createElement('div');
                    optionEl.className = 'quiz-option';
                    optionEl.textContent = option;
                    optionEl.style.animationDelay = (index * 0.05) + 's';
                    optionEl.classList.add('slide-in');
                    
                    optionEl.addEventListener('click', () => {
                        if (quizAnswered) return;
                        quizAnswered = true;

                        document.querySelectorAll('.quiz-option').forEach((el, i) => {
                            el.setAttribute('data-answered', 'true');
                            el.style.cursor = 'default';
                            if (i === correctIdx) {
                                el.classList.add('correct');
                            } else if (i === index && i !== correctIdx) {
                                el.classList.add('incorrect');
                            } else {
                                el.style.opacity = '0.6';
                            }
                        });

                        const isCorrect = index === correctIdx;
                        const fb = document.getElementById('quiz-feedback');
                        fb.textContent = isCorrect
                            ? 'Correct! ' + data.quiz.explanation
                            : 'Not quite. ' + data.quiz.explanation;
                        fb.style.display = 'block';
                        // Add class for specific coloring based on result
                        fb.className = 'quiz-feedback'; // reset
                        if(isCorrect) fb.style.borderLeftColor = 'var(--ff-success)';
                        else fb.style.borderLeftColor = 'var(--ff-runtime)';

                        if (window.vscode) {
                            window.vscode.postMessage({ type: 'quizAnswer', correct: isCorrect });
                        }
                    });
                    quizOptions.appendChild(optionEl);
                });
            } else {
                quizCard.style.display = 'none';
            }

            // Show content, hide empty state
            document.getElementById('empty-state').style.display = 'none';
            document.getElementById('error-content').style.display = 'block';
            document.getElementById('tts-controls').style.display = 'flex';
        }

        // ── VS Code Integration ──
        let vscode;
        try {
            vscode = acquireVsCodeApi();
            window.vscode = vscode;
        } catch (e) {
            console.log("Browser preview mode (no VS Code API)");
        }

        window.addEventListener('message', (event) => {
            const { type, data } = event.data;
            if (type === 'showError') {
                updatePanel(data);
            }
        });

        // ── Initialization (Mock Data for Preview) ──
        const MOCK_ERROR_DATA = {
            category: "Runtime Error",
            location: "App.tsx, line 15",
            errorMessage: "TypeError: Cannot read properties of undefined (reading 'map')",
            explanation: "You're trying to call .map() on a variable called 'data', but 'data' is undefined. This means the variable hasn't been assigned a value yet — likely because an API call hasn't finished loading when the component tries to render.",
            howToFix: [
                "Go to line 15 in App.tsx",
                "Initialize your state with an empty array: const [data, setData] = useState([])",
                "Or add a guard before .map(): data?.map(...)"
            ],
            howToPrevent: "Always initialize state variables with a sensible default value. If a variable will hold an array, initialize it as []. This prevents undefined errors when your component renders before async data arrives.",
            bestPractices: "Use optional chaining (data?.map()) and nullish coalescing (data ?? []) as defensive programming patterns. These are industry-standard approaches to safely handle values that might be null or undefined.",
            quiz: {
                question: "Why does calling .map() on 'data' throw a TypeError in this case?",
                options: [
                    "A) .map() is not a valid JavaScript method",
                    "B) 'data' is undefined because the state wasn't initialized with a default value",
                    "C) The API returned an error",
                    "D) .map() only works on strings, not arrays"
                ],
                correct: 1, // B (0-indexed)
                explanation: "Correct! The state variable 'data' was not given a default value (like []), so it starts as undefined. When React tries to render before the API data arrives, it calls .map() on undefined, which crashes."
            }
        };

        if (!vscode) {
            updatePanel(MOCK_ERROR_DATA);
        } else {
            vscode.postMessage({ type: 'ready' });
        }

        // ── ElevenLabs TTS ──
        const VOICES = {
            female: { id: 'EXAVITQu4vr4xnSDxMaL', name: 'Sarah' },
            male: { id: 'iP95p4xoKVk53GoZ742B', name: 'Chris' }
        };
        let selectedVoice = 'female';
        
        const voiceFemaleBtn = document.getElementById('voice-female');
        const voiceMaleBtn = document.getElementById('voice-male');
        
        voiceFemaleBtn.addEventListener('click', () => {
            selectedVoice = 'female';
            voiceFemaleBtn.classList.add('active');
            voiceMaleBtn.classList.remove('active');
        });
        voiceMaleBtn.addEventListener('click', () => {
            selectedVoice = 'male';
            voiceMaleBtn.classList.add('active');
            voiceFemaleBtn.classList.remove('active');
        });

        function cleanTextForTTS(html) {
            if (!html) return '';
            return html
                .replace(/<code>/g, '')
                .replace(/<\/code>/g, '')
                .replace(/<strong>/g, '')
                .replace(/<\/strong>/g, '')
                .replace(/<em>/g, '')
                .replace(/<\/em>/g, '')
                .replace(/<[^>]*>/g, '')
                .replace(/&amp;/g, '&')
                .replace(/&lt;/g, '<')
                .replace(/&gt;/g, '>')
                .replace(/&quot;/g, '"')
                .replace(/&#39;/g, "'")
                .replace(/\s+/g, ' ')
                .trim();
        }

        const ttsBtn = document.getElementById('tts-btn');
        let ttsAudio = null;
        let isSpeaking = false;

        ttsBtn.addEventListener('click', async () => {
            if (isSpeaking && ttsAudio) {
                ttsAudio.pause();
                ttsAudio = null;
                isSpeaking = false;
                ttsBtn.textContent = 'Read Aloud';
                return;
            }

            const data = currentErrorData || MOCK_ERROR_DATA;
            const fixText = Array.isArray(data.howToFix) ? data.howToFix.join('. ') : (data.howToFix || '');
            const textToRead = cleanTextForTTS([
                data.explanation,
                'Here is how to fix it. ' + fixText,
                'To prevent this in the future: ' + (data.howToPrevent || ''),
            ].join('. '));

            const apiKey = (typeof ELEVENLABS_API_KEY !== 'undefined' && ELEVENLABS_API_KEY !== 'your_api_key_here')
                ? ELEVENLABS_API_KEY : null;

            ttsBtn.textContent = 'Loading...';

            if (apiKey) {
                try {
                    const voice = VOICES[selectedVoice];
                    const res = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${voice.id}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'xi-api-key': apiKey },
                        body: JSON.stringify({
                            text: textToRead,
                            model_id: 'eleven_turbo_v2_5',
                            voice_settings: {
                                stability: 0.50,
                                similarity_boost: 0.65,
                                style: 0.10,
                                use_speaker_boost: true
                            }
                        })
                    });
                    if (!res.ok) throw new Error('API Error');
                    const blob = await res.blob();
                    const url = URL.createObjectURL(blob);
                    ttsAudio = new Audio(url);
                    isSpeaking = true;
                    ttsBtn.textContent = 'Stop';
                    ttsAudio.onended = () => {
                        isSpeaking = false;
                        ttsBtn.textContent = 'Read Aloud';
                        URL.revokeObjectURL(url);
                    };
                    ttsAudio.play();
                    return;
                } catch (e) {
                    console.warn('ElevenLabs TTS error:', e);
                }
            }

            // Fallback
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(textToRead);
                isSpeaking = true;
                ttsBtn.textContent = 'Stop';
                utterance.onend = () => { isSpeaking = false; ttsBtn.textContent = 'Read Aloud'; };
                speechSynthesis.speak(utterance);
            } else {
                ttsBtn.textContent = 'TTS Unavailable';
                setTimeout(() => { ttsBtn.textContent = 'Read Aloud'; }, 3000);
            }
        });
    </script>
</body>
</html>