<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Fix Review â€” Visual Debugger</title>
    <link rel="stylesheet" href="styles.css" />
    <script src="config.js"></script>
    <!-- diff2html CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/diff2html@3.4.48/bundles/css/diff2html.min.css" />
    <style>
        /* diff2html theme overrides for VS Code compatibility */
        .d2h-wrapper {
            background: transparent !important;
        }

        .d2h-file-header {
            background: var(--vscode-editor-background) !important;
            color: var(--vscode-foreground) !important;
            border-bottom: 1px solid var(--vscode-widget-border) !important;
        }

        .d2h-file-wrapper {
            border: 1px solid var(--vscode-widget-border) !important;
            border-radius: 4px;
            margin-bottom: 16px;
        }

        .d2h-code-linenumber,
        .d2h-code-side-linenumber,
        .d2h-code-line-ctn {
            font-family: var(--vscode-editor-font-family, 'Consolas', monospace) !important;
            font-size: var(--vscode-editor-font-size, 13px) !important;
            background: var(--vscode-editor-background);
            color: var(--vscode-editor-foreground);
        }

        /* Border fix for side-by-side view */
        .d2h-code-side-line {
            border-right: 1px solid var(--vscode-widget-border) !important;
        }

        /* Green for additions */
        .d2h-ins {
            background-color: var(--vscode-diffEditor-insertedTextBackground, rgba(155, 185, 85, 0.2)) !important;
            color: var(--vscode-editor-foreground) !important;
        }

        .d2h-ins .d2h-code-line-ctn {
            background-color: transparent !important;
        }

        /* Red for deletions */
        .d2h-del {
            background-color: var(--vscode-diffEditor-removedTextBackground, rgba(255, 0, 0, 0.2)) !important;
            color: var(--vscode-editor-foreground) !important;
        }

        .d2h-del .d2h-code-line-ctn {
            background-color: transparent !important;
        }
    </style>
</head>

<body>
    <div id="diff-panel">
        <!-- Header -->
        <div class="card-header">
            <h1>AI Fix Review</h1>
        </div>

        <!-- Empty state -->
        <div id="empty-state" class="card" style="text-align: center; padding: 32px 16px;">
            <p style="font-size: 1.1em; margin-bottom: 8px;">No AI fixes to review yet.</p>
            <p class="text-muted text-sm">After an error is detected, use an AI tool (Copilot, Cursor, etc.) to fix it. Visual Debugger will explain the changes.</p>
        </div>

        <!-- Diff content -->
        <div id="diff-content" style="display: none;">

        <!-- Diff Render Container -->
        <div class="card slide-in" id="diff-container" style="padding: 0; overflow: hidden; border: none; box-shadow: none;">
            <div class="card-header" style="margin: 0; padding: 10px; border-bottom: none; background: var(--vscode-editor-background);">
                <span class="badge" id="diff-category-badge"></span>
                <span class="text-muted text-sm" id="diff-file" style="margin-left: 8px;"></span>
            </div>
            <div id="diff-output">
                <!-- diff2html renders here -->
            </div>
        </div>

        <!-- AI Explanation Card ("Why It Broke") -->
        <div class="card slide-in diff-explanation" id="explanation-card">
            <div class="section">
                <div class="section-title">What the AI Changed</div>
                <div class="section-content" id="what-changed"></div>
            </div>

            <div class="section" style="margin-top: 16px;">
                <div class="section-title">Why This Fixes It</div>
                <div class="section-content" id="why-fixes"></div>
            </div>

            <div class="section" style="margin-top: 16px;">
                <div class="section-title">Key Takeaway</div>
                <div class="section-content" id="key-takeaway" style="font-weight: 500; font-style: italic;"></div>
            </div>
        </div>

        </div><!-- close #diff-content -->

        <!-- TTS Controls -->
        <div class="mt-12" id="tts-controls" style="display: none; align-items: center; gap: 10px; flex-wrap: wrap; margin-top: 20px;">
            <div class="voice-toggle-group">
                <button class="voice-toggle active" id="voice-female">Female</button>
                <button class="voice-toggle" id="voice-male">Male</button>
            </div>
            <button class="btn btn--secondary" id="tts-btn">Read Aloud</button>
        </div>
    </div>

    <!-- diff2html JS (CDN for browser preview) -->
    <script src="https://cdn.jsdelivr.net/npm/diff2html@3.4.48/bundles/js/diff2html.min.js"></script>
    <script>
        // â”€â”€ State â”€â”€
        let currentDiffData = null;

        // â”€â”€ VS Code Integration â”€â”€
        let vscode;
        try {
            vscode = acquireVsCodeApi();
            window.vscode = vscode;
        } catch (e) {
            console.log("Browser preview mode (no VS Code API)");
        }

        window.addEventListener('message', (event) => {
            const { type, data } = event.data;
            if (type === 'showDiff') {
                updatePanel(data);
            }
        });

        // â”€â”€ Main Update Function â”€â”€
        function updatePanel(data) {
            currentDiffData = data;

            const diffStr = data.unifiedDiff || (data.diff && data.diff.unifiedDiff) || '';
            const fileName = data.fileName || (data.diff && data.diff.file) || '';
            const category = data.category || '';

            // Render Diff
            renderDiff(diffStr);

            // Render Text Content
            const badge = document.getElementById('diff-category-badge');
            if (category) {
                badge.textContent = category;
                badge.style.display = 'inline-block';
                // Manual badge coloring logic if needed, or rely on styles.css default
                const type = category.split(' ')[0];
                if(type === 'Syntax') { badge.style.color = 'var(--ff-syntax)'; badge.style.borderColor = 'var(--ff-syntax)'; }
                else if(type === 'Logic') { badge.style.color = 'var(--ff-logic)'; badge.style.borderColor = 'var(--ff-logic)'; }
                else if(type === 'Runtime') { badge.style.color = 'var(--ff-runtime)'; badge.style.borderColor = 'var(--ff-runtime)'; }
            } else {
                badge.style.display = 'none';
            }
            
            document.getElementById('diff-file').textContent = fileName;
            document.getElementById('what-changed').innerHTML = data.whatChanged || '';
            document.getElementById('why-fixes').innerHTML = data.whyItFixes || '';
            document.getElementById('key-takeaway').innerHTML = data.keyTakeaway || '';

            // Show content
            document.getElementById('empty-state').style.display = 'none';
            document.getElementById('diff-content').style.display = 'block';
            document.getElementById('tts-controls').style.display = 'flex';
        }

        // â”€â”€ Render diff using diff2html â”€â”€
        function renderDiff(diffString) {
            const diffOutput = document.getElementById('diff-output');
            if (typeof Diff2Html !== 'undefined') {
                diffOutput.innerHTML = Diff2Html.html(diffString, {
                    drawFileList: false,
                    matching: 'lines',
                    outputFormat: 'side-by-side',
                    renderNothingWhenEmpty: false
                });
            } else {
                // Fallback
                diffOutput.innerHTML = '<pre style="padding: 12px; overflow-x: auto;"><code>' +
                    diffString.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</code></pre>';
            }
        }

        // â”€â”€ Initialization â”€â”€
        const MOCK_DIFF_DATA = {
            category: "Runtime Error",
            fileName: "App.tsx",
            unifiedDiff: `--- a/src/App.tsx
+++ b/src/App.tsx
@@ -12,8 +12,8 @@
 import { useState, useEffect } from 'react';
 
 function App() {
-  const [data, setData] = useState();
+  const [data, setData] = useState([]);
 
   useEffect(() => {
     fetch('/api/items')
@@ -22,7 +22,7 @@
   }, []);
 
   return (
-    <ul>{data.map(item => (
+    <ul>{data?.map(item => (
       <li key={item.id}>{item.name}</li>
     ))}</ul>
   );`,
            whatChanged: "The AI added a null check on line 15 before calling .map() and initialized the data state with an empty array [] instead of leaving it as undefined.",
            whyItFixes: "The original code assumed 'data' was always an array, but before the API response arrives, 'data' is undefined. By initializing it as [], .map() now has a valid (empty) array to iterate over.",
            keyTakeaway: "Always initialize state with a default value that matches the expected type."
        };

        if (!vscode) {
            updatePanel(MOCK_DIFF_DATA);
        } else {
            vscode.postMessage({ type: 'ready' });
        }

        // â”€â”€ ElevenLabs TTS â”€â”€
        const VOICES = {
            female: { id: 'EXAVITQu4vr4xnSDxMaL', name: 'Sarah' },
            male: { id: 'iP95p4xoKVk53GoZ742B', name: 'Chris' }
        };
        let selectedVoice = 'female';

        const voiceFemaleBtn = document.getElementById('voice-female');
        const voiceMaleBtn = document.getElementById('voice-male');

        voiceFemaleBtn.addEventListener('click', () => { selectedVoice = 'female'; voiceFemaleBtn.classList.add('active'); voiceMaleBtn.classList.remove('active'); });
        voiceMaleBtn.addEventListener('click', () => { selectedVoice = 'male'; voiceMaleBtn.classList.add('active'); voiceFemaleBtn.classList.remove('active'); });

        function cleanTextForTTS(html) {
            if (!html) return '';
            return html.replace(/<[^>]*>/g, '').replace(/\s+/g, ' ').trim();
        }

        const ttsBtn = document.getElementById('tts-btn');
        let ttsAudio = null;
        let isSpeaking = false;

        ttsBtn.addEventListener('click', async () => {
            if (isSpeaking && ttsAudio) {
                ttsAudio.pause(); ttsAudio = null; isSpeaking = false;
                ttsBtn.textContent = 'Read Aloud';
                return;
            }
            
            const data = currentDiffData || MOCK_DIFF_DATA;
            const textToRead = cleanTextForTTS(data.whatChanged + '. ' + data.whyItFixes + '. Key takeaway: ' + data.keyTakeaway);
            
            const apiKey = (typeof ELEVENLABS_API_KEY !== 'undefined' && ELEVENLABS_API_KEY !== 'your_api_key_here') ? ELEVENLABS_API_KEY : null;
            ttsBtn.textContent = 'Loading...';
            
            if (apiKey) {
                try {
                    const voice = VOICES[selectedVoice];
                    const res = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${voice.id}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'xi-api-key': apiKey },
                        body: JSON.stringify({
                            text: textToRead,
                            model_id: 'eleven_turbo_v2_5',
                            voice_settings: { stability: 0.50, similarity_boost: 0.65, style: 0.10, use_speaker_boost: true }
                        })
                    });
                    if (!res.ok) throw new Error('API Error');
                    const blob = await res.blob();
                    const url = URL.createObjectURL(blob);
                    ttsAudio = new Audio(url);
                    isSpeaking = true;
                    ttsBtn.textContent = 'Stop';
                    ttsAudio.onended = () => { isSpeaking = false; ttsBtn.textContent = 'Read Aloud'; URL.revokeObjectURL(url); };
                    ttsAudio.play();
                    return;
                } catch (e) { console.warn(e); }
            }
            
            if ('speechSynthesis' in window) {
                const u = new SpeechSynthesisUtterance(textToRead);
                isSpeaking = true;
                ttsBtn.textContent = 'â¹ï¸ Stop';
                u.onend = () => { isSpeaking = false; ttsBtn.textContent = 'ðŸ”Š Read Aloud'; };
                speechSynthesis.speak(u);
            } else {
                ttsBtn.textContent = 'âŒ TTS Unavailable';
                setTimeout(() => { ttsBtn.textContent = 'ðŸ”Š Read Aloud'; }, 3000);
            }
        });
    </script>
</body>
</html>